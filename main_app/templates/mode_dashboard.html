{% extends 'base.html' %}
{% load ansi_shadow_tags %}

{% block content %}
<div class="menu-bar">
  File  Edit  View  Format  Options  Range  Data  Help
</div>

<pre class="ascii-title">
<div class="ascii-terminal-style">{{ mode_data.mode.name|upper|ansi_shadow }}</div>
</pre>

<div class="terminal-output">
C:>ACCESS MODE_DETAILS.DAT
Loading mode data: {{ mode_data.mode.name }}
Status: {% if mode_data.mode.is_unlocked %}UNLOCKED{% else %}LOCKED{% endif %}
Progress: {{ mode_data.mode.progress_percentage }}%
Ready.
</div>

<div class="mode-header">
  <div class="mode-icon-large">{{ mode_data.mode.icon }}</div>
  <div class="mode-info">
    <h2>{{ mode_data.mode.name }}</h2>
    <p>{{ mode_data.mode.description }}</p>
    <div class="mode-status">
      {% if mode_data.mode.is_unlocked %}
        <span class="badge badge-success">UNLOCKED</span>
        <span class="text-muted">Triggered on: {{ mode_data.mode.triggered_on|date:"m/d/Y" }}</span>
      {% else %}
        <div class="loading-bar">
          <div class="loading-bar-fill" style="width: {{ mode_data.mode.progress_percentage }}%;"></div>
        </div>
        <span class="progress-text">{{ mode_data.mode.progress_percentage }}% complete</span>
      {% endif %}
    </div>
  </div>
</div>

<div class="dashboard-grid">
  <div class="dashboard-card focus-text" onclick="pulseMetrics()">
    <h3>Current Status</h3>
    <p class="mode-notes">{{ mode_data.current_data.notes }}</p>
    
    <div class="metric-grid">
      <div class="metric">
        <span class="metric-label">Current Progress</span>
        <span class="metric-value">{{ mode_data.current_data.progress }}%</span>
      </div>
      <div class="metric">
        <span class="metric-label">Status</span>
        <span class="metric-value">{% if mode_data.current_data.is_unlocked %}Unlocked{% else %}In Progress{% endif %}</span>
      </div>
    </div>
  </div>
  
  <div class="dashboard-card">
    <h3>Financial Tips</h3>
    <ul class="tips-list">
      {% for tip in mode_tips %}
        <li class="tip-item" onclick="highlightTip(this)">{{ tip }}</li>
      {% empty %}
        <li>No specific tips available for this mode.</li>
      {% endfor %}
    </ul>
  </div>
</div>

<h3 class="section-header">Mode History</h3>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th class="col-label"></th>
        <th class="col-label">A</th>
        <th class="col-label">B</th>
        <th class="col-label">C</th>
        <th class="col-label">D</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="row-label">1</td>
        <td><strong>date</strong></td>
        <td><strong>event</strong></td>
        <td><strong>progress</strong></td>
        <td><strong>details</strong></td>
      </tr>

      {% for event in mode_data.history %}
        <tr class="mode-row history-row" onclick="showEventDetails('{{ event.timestamp|date:"m/d/Y H:i" }}', '{{ event.status_change }}', {{ event.progress_percentage }}, '{{ event.details|escapejs }}')">
          <td class="row-label">{{ forloop.counter|add:"1" }}</td>
          <td>{{ event.timestamp|date:"m/d/Y H:i" }}</td>
          <td>
            {% if event.status_change == 'unlocked' %}
              <span class="badge badge-success">UNLOCKED</span>
            {% elif event.status_change == 'locked' %}
              <span class="badge badge-warning">LOCKED</span>
            {% else %}
              <span class="badge">PROGRESS</span>
            {% endif %}
          </td>
          <td>{{ event.progress_percentage }}%</td>
          <td class="text-muted details-cell">{{ event.details|truncatechars:30 }}</td>
        </tr>
      {% empty %}
        <tr>
          <td class="row-label">2</td>
          <td colspan="4">No history found for this mode.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if mode_data.progress_history|length > 1 %}
<div class="progress-chart-container focus-text">
  <h3>Progress History</h3>
  <p>Visualizing your progress over time</p>
  <div class="progress-chart" id="progressChart"></div>
</div>

<script>
  // Simple ASCII-style chart
  document.addEventListener('DOMContentLoaded', function() {
    const progressData = [
      {% for point in mode_data.progress_history %}
        {date: "{{ point.date|date:'m/d/Y' }}", progress: {{ point.progress }}},
      {% endfor %}
    ];
    
    if (progressData.length > 0) {
      // Sort by date
      progressData.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      // Simple ASCII chart
      const chartHeight = 10; // Lines of height
      const chartWidth = 50;  // Characters of width
      
      let chart = '';
      
      // Y-axis labels and horizontal lines
      for (let i = chartHeight; i >= 0; i--) {
        const value = Math.round((i / chartHeight) * 100);
        chart += `${value.toString().padStart(3, ' ')}% |`;
        
        // Add data points
        let line = '';
        for (let j = 0; j < chartWidth; j++) {
          const dataIndex = Math.floor(j * progressData.length / chartWidth);
          if (dataIndex < progressData.length) {
            const dataPoint = progressData[dataIndex];
            const normalizedValue = Math.round(dataPoint.progress / 100 * chartHeight);
            line += (normalizedValue >= chartHeight - i) ? '*' : ' ';
          }
        }
        
        chart += line + '\n';
      }
      
      // X-axis
      chart += '     +' + '-'.repeat(chartWidth) + '\n';
      
      // X-axis labels (first and last date)
      if (progressData.length > 1) {
        chart += '      ' + progressData[0].date.padEnd(chartWidth - 10, ' ') + progressData[progressData.length - 1].date;
      }
      
      document.getElementById('progressChart').innerHTML = '<pre>' + chart + '</pre>';
    }
  });
</script>
{% endif %}

<div class="function-keys">
  <div class="function-key" onclick="showHelpInfo()">F1-Help</div>
  <div class="function-key" onclick="window.location.reload()">F2-Refresh</div>
  <div class="function-key" onclick="window.location.href='{% url 'journey_map' %}'">F3-Journey</div>
  <div class="function-key" onclick="window.location.href='{% url 'unlocked_modes' %}'">F4-Modes</div>
</div>

<div class="status-bar">
  <span id="status-message">READY.</span>
  <span class="status-bar-brand">LEDGERLINE: Beige Edition</span>
  <span>{% now "m/d/Y" %}</span>
</div>

<style>
  .mode-header {
    display: flex;
    align-items: center;
    margin: 20px 0;
  }
  
  .mode-icon-large {
    font-size: 3rem;
    margin-right: 20px;
  }
  
  .mode-info {
    flex: 1;
  }
  
  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0;
  }
  
  @media (max-width: 768px) {
    .dashboard-grid {
      grid-template-columns: 1fr;
    }
  }
  
  .dashboard-card {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    padding: 15px;
    transition: all 0.25s ease;
    cursor: pointer;
  }
  
  .dashboard-card:hover {
    box-shadow: 0 0 15px rgba(0, 170, 0, 0.2);
    transform: translateY(-2px);
  }
  
  .metric-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 15px;
  }
  
  .metric {
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
  }
  
  .metric.highlight {
    transform: scale(1.05);
  }
  
  .metric-label {
    color: var(--text-muted);
    font-size: 0.9rem;
  }
  
  .metric-value {
    font-size: 1.5rem;
    font-weight: bold;
  }
  
  .tips-list {
    padding-left: 20px;
  }
  
  .tips-list li {
    margin-bottom: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    padding-left: 5px;
  }

  .tips-list li:hover {
    color: var(--text-highlight) !important;
  }
  
  .tips-list li.highlight {
    color: var(--text-highlight) !important;
    transform: translateX(5px);
    font-weight: bold;
  }
  
  .mode-notes {
    color: var(--text-highlight);
    font-style: italic;
    margin-bottom: 15px;
  }
  
  .progress-chart-container {
    margin: 30px 0;
  }
  
  .progress-chart {
    font-family: monospace;
    white-space: pre;
    overflow: auto;
  }
  
  .section-header {
    margin-top: 30px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 5px;
  }
  
  .details-cell {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .history-row {
    cursor: pointer;
    transition: all 0.25s ease;
  }
  
  .history-row:hover {
    background-color: #111 !important;
  }
  
  .history-row.active {
    background-color: #001a00 !important;
    border-left: 3px solid var(--text-highlight);
  }
  
  @keyframes flash {
    0% { background-color: #000000; }
    30% { background-color: #002200; }
    100% { background-color: #000000; }
  }
  
  .flash {
    animation: flash 0.8s;
  }
</style>

<script>
function showHelpInfo() {
  const helpText = `MODE DASHBOARD HELP:
- This dashboard shows detailed information about the ${mode_data.mode.name}
- The current status section displays your latest metrics
- Financial tips provide guidance specific to this mode
- The mode history table shows all events related to this mode
- The progress chart visualizes how your progress has changed over time
- Use F3 to return to the Journey Map view`;
  
  // Find or create terminal output
  let output = document.querySelector('.terminal-output');
  
  // Update content
  output.innerHTML = helpText.replace(/\n/g, '<br>');
  
  // Update status
  document.getElementById('status-message').textContent = "Displaying help documentation";
}

function pulseMetrics() {
  // Add highlight effect to metrics
  const metrics = document.querySelectorAll('.metric');
  metrics.forEach(metric => {
    metric.classList.add('highlight');
    
    setTimeout(() => {
      metric.classList.remove('highlight');
    }, 800);
  });
  
  // Update status message
  document.getElementById('status-message').textContent = "Refreshing metrics...";
  
  // Add fancy loading effect
  const card = document.querySelector('.dashboard-card');
  card.classList.add('flash');
  
  setTimeout(() => {
    card.classList.remove('flash');
    document.getElementById('status-message').textContent = "Metrics updated";
  }, 1000);
  
  setTimeout(() => {
    document.getElementById('status-message').textContent = "READY.";
  }, 3000);
}

function highlightTip(tipElement) {
  // Remove highlight from all tips
  document.querySelectorAll('.tip-item').forEach(tip => {
    tip.classList.remove('highlight');
  });
  
  // Add highlight to clicked tip
  tipElement.classList.add('highlight');
  
  // Update status
  document.getElementById('status-message').textContent = "Tip selected";
  
  // After a delay, reset status
  setTimeout(() => {
    document.getElementById('status-message').textContent = "READY.";
  }, 2000);
}

function showEventDetails(timestamp, statusChange, progress, details) {
  // Reset all rows
  document.querySelectorAll('.history-row').forEach(row => {
    row.classList.remove('active');
  });
  
  // Highlight clicked row
  event.currentTarget.classList.add('active');
  
  // Update terminal output with full details
  const output = document.querySelector('.terminal-output');
  
  let statusText = statusChange === 'unlocked' ? 'UNLOCKED' : 
                  statusChange === 'locked' ? 'LOCKED' : 'PROGRESS UPDATE';
  
  const detailsText = `EVENT DETAILS:
Timestamp: ${timestamp}
Status: ${statusText}
Progress: ${progress}%
Details: ${details}`;
  
  // Add typing effect
  output.innerHTML = '';
  let i = 0;
  const speed = 20; // typing speed in ms
  
  function typeWriter() {
    if (i < detailsText.length) {
      output.innerHTML += detailsText.charAt(i) === '\n' ? '<br>' : detailsText.charAt(i);
      i++;
      setTimeout(typeWriter, speed);
    } else {
      // Add blinking cursor at the end
      output.innerHTML += '<span class="blinking-cursor"></span>';
    }
  }
  
  typeWriter();
  
  // Update status
  document.getElementById('status-message').textContent = "Displaying event details";
}
</script>
{% endblock %} 