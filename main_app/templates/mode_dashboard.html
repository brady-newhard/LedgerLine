{% extends 'base.html' %}
{% load ansi_shadow_tags %}

{% block content %}
<div class="terminal-container">
    <div class="terminal-header">
        {% ansi_shadow "MODE DASHBOARD" %}
        <div class="version-indicator">
            <span class="version-text">v2.84 Terminal Edition</span>
            <span class="version-hint">[Emulation active]</span>
        </div>
    </div>
    
    <div class="terminal-output hidden">
        <!-- Will be populated by JavaScript -->
    </div>
    
    <div class="mode-header">
        <div class="mode-icon">{{ mode.icon|default:"üí∞" }}</div>
        <div class="mode-info">
            <h1 class="mode-name">{{ mode.name }} <span class="mode-badge">{{ mode.status }}</span></h1>
            <div class="hidden-mode-trigger" id="secret-mode-trigger" data-clicks="0"></div>
        </div>
    </div>
    
    <div class="menu-bar">
        <div class="menu-item" onclick="showOverview()">Overview</div>
        <div class="menu-item" onclick="showStatus()">Status</div>
        <div class="menu-item" onclick="showHistory()">History</div>
        <div class="menu-item" onclick="showTips()">Tips</div>
        <div class="menu-item hidden" id="advanced-menu-item" onclick="showAdvancedView()">Advanced</div>
    </div>
    
    <div class="terminal-body">
        <div class="dashboard-grid">
            <div class="grid-item current-status">
                <h2>Current Status</h2>
                <div class="status-metrics">
                    <div class="metric">
                        <div class="metric-label">Progress</div>
                        <div class="metric-value">{{ mode.progress_percentage }}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ mode.progress_percentage }}%;"></div>
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Streak</div>
                        <div class="metric-value">{{ mode.streak_days }} days</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Triggered</div>
                        <div class="metric-value">{{ mode.triggered_date|date:"M d, Y" }}</div>
                    </div>
                </div>
            </div>
            
            <div class="grid-item financial-tips">
                <h2>Financial Tips</h2>
                <div class="tips-container">
                    <div class="tip">
                        <div class="tip-icon">üí°</div>
                        <div class="tip-content">
                            <div class="tip-title">Track your expenses regularly</div>
                            <div class="tip-description">Regular tracking helps you maintain awareness of your spending habits.</div>
                        </div>
                    </div>
                    <div class="tip">
                        <div class="tip-icon">üìä</div>
                        <div class="tip-content">
                            <div class="tip-title">Set clear financial goals</div>
                            <div class="tip-description">Having specific goals helps guide your financial decisions and measure progress.</div>
                        </div>
                    </div>
                    <div class="tip easter-egg-tip" onclick="revealEasterEgg(event)">
                        <div class="tip-icon">üîç</div>
                        <div class="tip-content">
                            <div class="tip-title">Look deeper</div>
                            <div class="tip-description">The interface may hide more than it shows. <span class="glitch-text">Curious users are rewarded.</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid-item history-table">
                <h2>Mode History</h2>
                <div class="history-container">
                    {% if history %}
                        <table class="terminal-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in history %}
                                <tr>
                                    <td>{{ entry.timestamp|date:"M d, Y" }}</td>
                                    <td>{{ entry.status_change }}</td>
                                    <td>{{ entry.progress_percentage }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>No history available for this mode.</p>
                        <p class="easter-egg-text">System awaiting sufficient user data for pattern analysis...</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="grid-item progress-chart">
                <h2>Progress Chart</h2>
                <div class="chart-container">
                    {% if history|length > 1 %}
                        <canvas id="progressChart"></canvas>
                    {% else %}
                        <p>Not enough data to display a progress chart.</p>
                        <p class="easter-egg-text">Advanced visualization capabilities ready when data threshold is met.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="terminal-footer">
        <div class="footer-actions">
            <a href="{% url 'unlocked_modes' %}" class="terminal-button">View All Modes</a>
            <a href="{% url 'journey_map' %}" class="terminal-button">Journey Map</a>
            <a href="{% url 'home' %}" class="terminal-button">Back to Dashboard</a>
        </div>
    </div>
    
    <div class="function-keys">
        <div class="function-key" onclick="showHelpInfo()">F1-Help</div>
        <div class="function-key" onclick="window.location.href='{% url 'home' %}'">F2-Home</div>
        <div class="function-key" onclick="window.location.href='{% url 'unlocked_modes' %}'">F3-Modes</div>
        <div class="function-key" onclick="window.location.href='{% url 'transaction_list' %}'">F4-Ledger</div>
        <div class="function-key hidden" id="advanced-function-key" onclick="showAdvancedView()">F9-Reality</div>
    </div>
    
    <div class="status-bar">
        <span id="status-message">READY.</span>
        <span class="status-bar-brand">LEDGERLINE: Terminal Edition <span class="glitch-text">[Emulation]</span></span>
        <span>{% now "m/d/Y" %}</span>
    </div>
</div>

<!-- Hidden Advanced View Container -->
<div id="advanced-view-container" class="advanced-view-container hidden">
    <div class="advanced-view-content">
        <div class="advanced-header">
            <h1>Advanced Financial Analysis</h1>
            <div class="close-button" onclick="hideAdvancedView()">√ó</div>
        </div>
        <div class="advanced-body">
            <p>Access denied. Insufficient privileges.</p>
            <p>Continue your financial journey to unlock advanced capabilities.</p>
            <div class="advanced-progress-bar">
                <div class="advanced-progress-fill" style="width: {{ mode.progress_percentage }}%;"></div>
            </div>
            <p class="advanced-progress-text">{{ mode.progress_percentage }}% complete</p>
        </div>
    </div>
</div>

<script>
let secretProgress = 0;
const SECRET_THRESHOLD = 7;
let secretKeySequence = '';
const SECRET_CODE = 'reality';

// Initialize glitch effects
document.addEventListener('DOMContentLoaded', function() {
    // Random micro-glitches
    setInterval(() => {
        if (Math.random() < 0.05) { // 5% chance each interval
            const glitch = document.createElement('div');
            glitch.className = 'micro-glitch';
            document.body.appendChild(glitch);
            
            setTimeout(() => {
                document.body.removeChild(glitch);
            }, 100);
        }
    }, 30000); // Check every 30 seconds
    
    // Occasional version hint flicker
    setInterval(() => {
        const versionHint = document.querySelector('.version-hint');
        if (versionHint) {
            versionHint.classList.add('flicker');
            setTimeout(() => {
                versionHint.classList.remove('flicker');
            }, 2000);
        }
    }, 60000); // Every minute
    
    // Setup secret trigger in mode icon
    const modeIcon = document.querySelector('.mode-icon');
    if (modeIcon) {
        modeIcon.addEventListener('click', () => {
            secretProgress++;
            if (secretProgress === 3) {
                showHint('User exhibits curiosity. Additional system features may be accessible.');
            }
            if (secretProgress >= SECRET_THRESHOLD) {
                document.getElementById('advanced-menu-item').classList.remove('hidden');
                document.getElementById('advanced-function-key').classList.remove('hidden');
                showHint('System notice: Advanced features unlocked.');
            }
        });
    }
    
    // Setup secret key listener
    document.addEventListener('keydown', (e) => {
        secretKeySequence += e.key.toLowerCase();
        
        // Only keep the last 7 characters
        if (secretKeySequence.length > 7) {
            secretKeySequence = secretKeySequence.substring(secretKeySequence.length - 7);
        }
        
        // Check if the secret code is contained in the current sequence
        if (secretKeySequence.includes(SECRET_CODE)) {
            secretKeySequence = ''; // Reset
            showAdvancedView();
        }
    });
    
    // Progress chart initialization
    {% if history|length > 1 %}
    const ctx = document.getElementById('progressChart').getContext('2d');
    
    // Extract data from history
    const labels = [{% for entry in history %}"{{ entry.timestamp|date:'M d' }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
    const data = [{% for entry in history %}{{ entry.progress_percentage }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    
    // Create chart
    const progressChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Progress %',
                data: data,
                borderColor: '#5f5',
                backgroundColor: 'rgba(95, 255, 95, 0.1)',
                tension: 0.2,
                borderWidth: 2,
                pointBackgroundColor: '#5f5',
                pointRadius: 3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: '#111',
                    titleColor: '#5f5',
                    bodyColor: '#fff',
                    borderColor: '#5f5',
                    borderWidth: 1,
                    displayColors: false
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#aaa',
                        font: {
                            family: 'monospace'
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#aaa',
                        font: {
                            family: 'monospace'
                        },
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
    {% endif %}
});

function showHelpInfo() {
    const helpText = `MODE DASHBOARD HELP:
- This dashboard shows your progress in the '{{ mode.name }}' financial mode
- View your current status, progress, and history
- Find financial tips related to this mode
- Track your progress over time with the progress chart
<span class="glitch-text">[Info: Advanced analytical tools restricted in compatibility mode]</span>`;

    let output = document.querySelector('.terminal-output');
    if (!output) {
        output = document.createElement('div');
        output.className = 'terminal-output';
        document.querySelector('.terminal-container').insertBefore(
            output, 
            document.querySelector('.mode-header')
        );
    }
    
    output.classList.remove('hidden');
    output.innerHTML = helpText.replace(/\n/g, '<br>');
    document.getElementById('status-message').textContent = "Displaying help information";
    
    // Increment secret progress
    secretProgress++;
    if (secretProgress >= SECRET_THRESHOLD) {
        document.getElementById('advanced-menu-item').classList.remove('hidden');
        document.getElementById('advanced-function-key').classList.remove('hidden');
    }
}

function showHint(message) {
    let output = document.querySelector('.terminal-output');
    if (!output) {
        output = document.createElement('div');
        output.className = 'terminal-output';
        document.querySelector('.terminal-container').insertBefore(
            output, 
            document.querySelector('.mode-header')
        );
    }
    
    output.classList.remove('hidden');
    output.innerHTML = `<span class="glitch-text">${message}</span>`;
    
    setTimeout(() => {
        output.innerHTML = '';
        output.classList.add('hidden');
    }, 4000);
}

function showOverview() {
    document.getElementById('status-message').textContent = "Showing mode overview";
}

function showStatus() {
    document.getElementById('status-message').textContent = "Showing mode status";
}

function showHistory() {
    document.getElementById('status-message').textContent = "Showing mode history";
}

function showTips() {
    document.getElementById('status-message').textContent = "Showing financial tips";
}

function showAdvancedView() {
    const advancedContainer = document.getElementById('advanced-view-container');
    advancedContainer.classList.remove('hidden');
    
    // Add glitch effect during transition
    const glitch = document.createElement('div');
    glitch.className = 'reality-glitch';
    document.body.appendChild(glitch);
    
    setTimeout(() => {
        document.body.removeChild(glitch);
    }, 200);
    
    document.getElementById('status-message').textContent = "ACCESSING ADVANCED SYSTEMS...";
}

function hideAdvancedView() {
    const advancedContainer = document.getElementById('advanced-view-container');
    advancedContainer.classList.add('hidden');
    document.getElementById('status-message').textContent = "RETURNING TO COMPATIBILITY MODE";
    
    setTimeout(() => {
        document.getElementById('status-message').textContent = "READY.";
    }, 2000);
}

function revealEasterEgg(event) {
    // Increment the secret progress
    secretProgress += 2;
    
    // Show a brief glitch
    const glitch = document.createElement('div');
    glitch.className = 'micro-glitch';
    document.body.appendChild(glitch);
    
    setTimeout(() => {
        document.body.removeChild(glitch);
    }, 100);
    
    // Create a mysterious message
    showHint("Curious minds find what others overlook. Keep exploring.");
    
    // If threshold reached, reveal advanced options
    if (secretProgress >= SECRET_THRESHOLD) {
        document.getElementById('advanced-menu-item').classList.remove('hidden');
        document.getElementById('advanced-function-key').classList.remove('hidden');
    }
    
    // Apply some visual effect to the clicked element
    const tipElement = event.currentTarget;
    tipElement.classList.add('easter-egg-activated');
    
    setTimeout(() => {
        tipElement.classList.remove('easter-egg-activated');
    }, 1000);
}
</script>
{% endblock %}

{% block styles %}
<style>
    /* Version indicator */
    .version-indicator {
        font-size: 0.7rem;
        text-align: right;
        margin-top: -10px;
        margin-bottom: 10px;
        opacity: 0.6;
    }
    
    .version-hint {
        color: #ff5555 !important;
        margin-left: 10px;
        opacity: 0.5;
        font-style: italic;
        cursor: help;
    }
    
    .version-hint:hover {
        opacity: 0.9;
    }
    
    .flicker {
        animation: textFlicker 2s;
    }
    
    @keyframes textFlicker {
        0% { opacity: 0.5; }
        5% { opacity: 0; }
        10% { opacity: 0.7; }
        15% { opacity: 0.2; }
        20% { opacity: 0.6; }
        25% { opacity: 0.9; }
        30% { opacity: 0.2; }
        35% { opacity: 0.7; }
        40% { opacity: 0.5; }
        45% { opacity: 0.2; }
        50% { opacity: 0.7; }
        55% { opacity: 0.5; }
        60% { opacity: 0.7; }
        100% { opacity: 0.5; }
    }
    
    /* Modern glitch elements */
    .reality-glitch {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(0, 136, 255, 0.2), rgba(0, 255, 170, 0.2));
        z-index: 9999;
        pointer-events: none;
        animation: realityGlitch 0.15s;
    }
    
    @keyframes realityGlitch {
        0% { opacity: 0; }
        50% { opacity: 1; }
        100% { opacity: 0; }
    }
    
    .micro-glitch {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 136, 255, 0.05);
        z-index: 9999;
        pointer-events: none;
        animation: microGlitch 0.1s;
    }
    
    @keyframes microGlitch {
        0% { opacity: 0; }
        50% { opacity: 0.5; }
        100% { opacity: 0; }
    }
    
    .glitch-text {
        animation: glitchText 5s infinite;
        display: inline-block;
        color: #ff5555 !important;
    }
    
    @keyframes glitchText {
        0% { opacity: 1; }
        0.1% { opacity: 0; transform: translateX(1px); }
        0.2% { opacity: 1; transform: translateX(0); }
        25% { opacity: 1; }
        25.1% { opacity: 0; transform: translateX(-1px); }
        25.2% { opacity: 1; transform: translateX(0); }
        85% { opacity: 1; }
        85.1% { opacity: 0; transform: translateY(1px); }
        85.2% { opacity: 1; transform: translateY(0); }
        100% { opacity: 1; }
    }
    
    /* Easter egg text */
    .easter-egg-text {
        opacity: 0.5;
        font-size: 0.85em;
        color: #555 !important;
        display: block;
        margin-top: 5px;
        cursor: help;
    }
    
    .easter-egg-text:hover {
        color: #00ffff !important;
    }
    
    /* Advanced view styling */
    .advanced-view-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        animation: fadeIn 0.5s forwards;
    }
    
    @keyframes fadeIn {
        0% { opacity: 0; }
        100% { opacity: 1; }
    }
    
    .advanced-view-content {
        width: 80%;
        max-width: 800px;
        background: linear-gradient(135deg, #001a3a, #003a3a);
        border-radius: 10px;
        padding: 20px;
        color: white !important;
        box-shadow: 0 0 30px rgba(0, 170, 255, 0.3);
    }
    
    .advanced-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .advanced-header h1 {
        margin: 0;
        color: white !important;
        font-size: 1.8rem;
    }
    
    .close-button {
        font-size: 2rem;
        cursor: pointer;
        color: #aaa !important;
        transition: color 0.3s;
    }
    
    .close-button:hover {
        color: white !important;
    }
    
    .advanced-body {
        text-align: center;
        padding: 20px;
    }
    
    .advanced-progress-bar {
        height: 20px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        margin: 20px 0;
        overflow: hidden;
    }
    
    .advanced-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #00aaff, #00ffaa);
        transition: width 1s ease;
    }
    
    .advanced-progress-text {
        color: #00aaff !important;
        font-weight: bold;
    }
    
    /* Easter egg tip styling */
    .easter-egg-tip {
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }
    
    .easter-egg-tip::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(0, 170, 255, 0), rgba(0, 170, 255, 0.1));
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .easter-egg-tip:hover::after {
        opacity: 1;
    }
    
    .easter-egg-activated {
        animation: easterEggPulse 1s;
    }
    
    @keyframes easterEggPulse {
        0% { transform: scale(1); box-shadow: none; }
        50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 170, 255, 0.5); }
        100% { transform: scale(1); box-shadow: none; }
    }
    
    /* Secret trigger */
    .hidden-mode-trigger {
        position: absolute;
        top: 0;
        right: 0;
        width: 20px;
        height: 20px;
        cursor: pointer;
        opacity: 0;
    }
    
    /* Keep existing styles below */
    .mode-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #333;
        position: relative;
    }
    
    .mode-icon {
        font-size: 3em;
        cursor: pointer;
        transition: transform 0.3s ease, text-shadow 0.3s ease;
    }
    
    .mode-icon:hover {
        transform: scale(1.1);
        text-shadow: 0 0 10px rgba(95, 255, 95, 0.7);
    }
    
    .mode-info {
        flex-grow: 1;
        position: relative;
    }
    
    .mode-name {
        margin: 0;
        font-size: 1.8em;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .mode-badge {
        font-size: 0.6em;
        background-color: #5f5;
        color: #000;
        padding: 2px 8px;
        border-radius: 10px;
        text-transform: uppercase;
    }
    
    .menu-bar {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
    }
    
    .menu-item {
        cursor: pointer;
        padding: 5px 10px;
        transition: color 0.2s ease;
    }
    
    .menu-item:hover {
        color: #5f5;
    }
    
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }
    
    .grid-item {
        background-color: #111;
        border: 1px solid #333;
        border-radius: 5px;
        padding: 15px;
    }
    
    .grid-item h2 {
        margin-top: 0;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    
    .status-metrics {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .metric {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .metric-label {
        font-size: 0.9em;
        color: #aaa;
    }
    
    .metric-value {
        font-size: 1.2em;
        font-weight: bold;
    }
    
    .progress-bar {
        background-color: #222;
        height: 10px;
        border-radius: 5px;
        overflow: hidden;
    }
    
    .progress-fill {
        background-color: #5f5;
        height: 100%;
        transition: width 0.5s ease-in-out;
    }
    
    .tips-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .tip {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        padding: 10px;
        border-radius: 5px;
        transition: background-color 0.2s ease;
    }
    
    .tip:hover {
        background-color: #1a1a1a;
    }
    
    .tip-icon {
        font-size: 1.5em;
    }
    
    .tip-content {
        flex-grow: 1;
    }
    
    .tip-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .tip-description {
        font-size: 0.9em;
        color: #aaa;
    }
    
    .history-container {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .terminal-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .terminal-table th,
    .terminal-table td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #333;
    }
    
    .terminal-table th {
        background-color: #1a1a1a;
        font-weight: bold;
    }
    
    .chart-container {
        height: 200px;
        position: relative;
    }
    
    .terminal-footer {
        margin-top: 20px;
        text-align: center;
    }
    
    .footer-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
    }
    
    .terminal-button {
        background-color: #333;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    .terminal-button:hover {
        background-color: #555;
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
    }
    
    .hidden {
        display: none !important;
    }
</style>
{% endblock %}